<!DOCTYPE html>
<html class="no-js">
<head>
<link href="../../css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="../../css/main.css">
<meta charset='UTF-8'>
<style>

.no-js {display:none;}
#map {  
        display:inline-block;
        margin:10px auto;
        width: 300px;
        height: 300px;
        border: 1px groove gray;
      }
.hr-sect {
    display: flex;
    flex-basis: 100%;
    align-items: center;
    color: rgba(0, 0, 0, 0.35);
    margin: 8px 0px;
}
.hr-sect::before,
.hr-sect::after {
    content: "";
    flex-grow: 1;
    background: rgba(0, 0, 0, 0.35);
    height: 1px;
    font-size: 0px;
    line-height: 0px;
    margin: 0px 8px;
}
</style>
<title>아이템 상세 정보</title>
</head>

<body>

<header></header>

<div class="container">
<div class="row">
<div class="col-md-4 col-sm-6 col-xs-12 mx-auto">
<div class="card-body">
    <div id='aa' class="card-text">
  </div>
    
      <h4 id='actname' class="py-3 text_center" style="color:#3680C1"></h4>
      <p class="text_center text-muted"></p>
  
</div>
<div class="card-body text-center">
<p id="title" class="card-text"></p>
</div>
</div>
</div>

<div class="row">
<div class="col-sm-6 mx-auto">
<div id="trinfo" class="card-body" style="display: block;">
<p id="date" class="card-text text_right text-muted"></p>
</div>
</div>
</div>
<div class="row">
<div class="mx-auto">
<button id='dealBtn' type="button" class="btn btn-primary float-left mr-2">거래하기</button>
<button id='priceBtn' type="button" class="btn btn-primary float-right">결제하기</button>
    </div>
</div>

<div class="hr-sect my-5 col-8 mx-auto"><h4 class="hr-sect mb-0">사진</h4></div>
 
    
<div class="row py-2">
<div class="mx-auto">
    <div id="itemphoto"></div>
    </div>
</div>

<div style="display: none;" id="rivewBar" class="hr-sect my-5 col-8 mx-auto"><h4 class="hr-sect mb-0">리뷰</h4></div>

<div class="row py-2">
<div id='review' class="mx-auto col-5" style="text-align: center;">
</div>
</div>

<div>
<div id="map"></div><span id="distance"></span><button type="button" class="btn" onclick="distanceCalculator()">거리 계산</button>
<button type="button" class="btn" onclick="routeOpen()">길찾기</button>
</div>

</div>
<br><br><br><br><br><br><br><br><br>

<!--결제창 -->
<div class="modal fade" id="priceModal" tabindex="-1" role="dialog" aria-labelledby="priceModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="priceModalLabel">결제화면</h5>
        <button id='closeModal' type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      <div id='itempic1' class="d-inline-block" style="width:150px; height: 150px;background-size: 100% 100%">
      </div>
      <div id='dp' class="d-inline-block mt-3 ml-3" style="position: absolute;">
      <span id='pr'></span>
      <div class='py-4' id='itemName'></div>
      </div>
      <div class='m-3'>
      결제 방법: 
       <input class="payMethod" type="radio" checked name="payMethod" value="card">
       카드결제
       <input class="payMethod" type="radio" name="payMethod" value="trans">
       실시간 계좌 이체
       <input class="payMethod" type="radio" name="payMethod" value="phone">
       휴대폰 결제
      </div>
      <div class='m-3'>
      배송비 유형:
      <input id='prepaid' class='deliberypay' type="radio" name="deliveryPayType" value=1 checked>선불
      <input id='afterpay' class='deliberypay' type="radio" name="deliveryPayType" value=0>착불
      </div>
      <div class="modal-footer">
      </div>
        <button type="button" class="btn btn-primary" onclick="pay()">결제</button>
      </div>
    </div>
  </div>
</div>


<script id='t1' type="text/x-handlebars-template">
{{#each photos}}
<a href="/download/{{thumbnailName}}">
    <img src="/download/{{thumbnailName}}" class="img-responsive rounded-circle" style="width:100%"></a>
{{/each}}
</script>
<script id='t2' type="text/x-handlebars-template">
{{#each this}}
<a data-toggle="modal" data-target="#exampleModal{{@index}}" href="/download/{{this}}">
    <img src="/download/{{this}}" style="height: 225px; width: 250px; display: inline-block; margin: 10px;"></a>
{{/each}}
</script>
<script id='t4' type="text/x-handlebars-template">
{{#each this}}
<div class="modal fade" id="exampleModal{{@index}}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      <div class="modal-body mx-auto">
        <img class="img-fluid" src="/download/{{this}}"></a>
        <div id="kartik-file-errors"></div>
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>
{{/each}}
</script>

<script id='t3' type="text/handlebars-template">
<table class="table table-bordered">
<tbody><tr><th style="background-color: #f3f3f3;" class="text-center align-middle" rowspan="4">대여</th></tr>
<tr><td><span>물품</span><span style="float: right;">{{itemName}}</span></td></tr>
<tr><td class="text-muted" type="date"><span>기간</span><span style="float: right;">{{formatDate startDate}} ~ {{formatDate endDate}}</span></td></tr>
<tr><td><span>가격</span><span style="float: right;">{{fb price}} 원</span></td></tr>
</tbody>
</table>
</div>
</script>

<script src="https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js"></script>
<script src='/node_modules/handlebars/dist/handlebars.min.js'></script>
<script src='/node_modules/moment/moment.js'></script>
<script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>
<script src="https://static.nid.naver.com/js/naveridlogin_js_sdk_2.0.0.js" charset="utf-8"></script>
<script src='/node_modules/jquery/dist/jquery.min.js'></script>
<script src='/node_modules/popper.js/dist/umd/popper.min.js'></script>
<script src='/node_modules/bootstrap/dist/js/bootstrap.min.js'></script>
<script src='/node_modules/sweetalert/dist/sweetalert.min.js'></script>
<script type="text/javascript" src="https://service.iamport.kr/js/iamport.payment-1.1.5.js"></script>
<script type="text/javascript" src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=41a90b1059ade44d7db374c4db586dfb&libraries=services"></script>


<script type="text/javascript">

var IMP = window.IMP;
IMP.init("imp92089366");
var itemNo, price, slat, slng, elat, elng, userNo;
var template1Src = $('#t1').html(),
template2Src = $('#t2').html(),
template3Src = $('#t3').html(),
template4Src = $('#t4').html(),
template1Engine = Handlebars.compile(template1Src),
template2Engine = Handlebars.compile(template2Src),
template3Engine = Handlebars.compile(template3Src),
template4Engine = Handlebars.compile(template4Src);

$('header').load('../header.html');

Handlebars.registerHelper('fb', transPrice);

Handlebars.registerHelper('formatDate', function(date) {
    return moment(date).format('YYYY-MM-DD');
});

$.ajax("/json/maps/get",{
    type: 'POST',
    dataType: 'json',
    success: (result) => {
        slat= result.map.latitude;
        slng= result.map.longitude;
    },
    error: () => {
        swal("로그인 회원정보의 주소 정보 로드 실패");
    }
})

$('#priceBtn').click(() => {
    $.getJSON('/json/auth/loginUser', function(result) {
            if (result.status == "fail"){
                swal("로그인이 필요한 페이지 입니다.").then((value) => {
                    $('#loginBtn').click()     
                })
                return;
            } else {
                $('#priceModal').modal('show')
            } 
        })
})

//길찾기 새탭에서 호출
function routeOpen() {
    if (slng == elng && slat == elat) {
        return swal("출발지와 도착지가 같습니다.");
    }    
    window.open("http://map.naver.com/index.nhn?slng="+slng+"&slat="+slat+
            "&stext=출발지&elng="+elng+"&elat="+elat+"&etext=도착지&menu=route", "_blank");
}

//거래하기
$('#dealBtn').click(() => {
    $.getJSON('/json/auth/loginUser', function(result) {
            if (result.status == "fail"){
                swal("로그인이 필요한 페이지 입니다.").then((value) => {
                    $('#loginBtn').click()     
                })
                return;
            } else {
                if (result.user.userNo == userNo) {
                swal('본인 아이템을 구매할 수 없습니다');
                throw stop;
                }
                swal({
                    html: true,
                    title:"거래하시겠습니까?",
                    text: "판매자의 연락처가 메시지함으로 전송됩니다.\n" +
                    "전송된 연락처로 직접 연락하여 거래하세요! ",
                    buttons:{
                            confirm: {text: "OK", value: true},
                            cancel: {text: "NO",value: false ,visible: true}
                            }
                }).then((value)=> {
                      if (value){
                          $.ajax("/json/tr/add", {
                              method: "POST",
                              dataType: 'json',
                              data: {
                                  itemNo: itemNo,
                                  selectAdd: 2
                              },
                              success: (result) => {
                                  swal('거래를 신청하였습니다');
                                  $('#priceBtn').prop("disabled",'true').html("거래중입니다");
                                  $('#dealBtn').hide();
                              },
                              error: (request,status,error) => {
                                  swal("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                                  }
                              
                          });
                      }
                      else 
                          swal("취소하셨습니다!")
                  })
            } 
        })
})


var index = location.href.indexOf('?');

if (index != -1) { // 기존 데이터를 조회할 경우
    var qs = location.href.substr(index + 1);
    var arr = qs.split('=');
}   

    $.ajax('/json/item/' + arr[1], {
        dataType: 'json',
        success: (result) => {
            $('#aa').html(template1Engine(result.user));
            for (var data of result.item.photos) {
                var photo = data.photoName.split(',');
                var thumb = data.thumbnailName.split(',');
            }
            $('#itempic1').css("background-image","url('/download/"+thumb[0]+"')");
            $('#itemName').html('물품명:'+result.item.itmeName);
            price = result.item.price + 2500;
            $('#dp').prepend('기간 : ' + moment(result.item.startDate).format('YYYY-MM-DD') + ' ~ ' +
                    moment(result.item.endDate).format('YYYY-MM-DD') +'<br><br>' + 
                    '가격 : ');
            $('#pr').html(transPrice(price)+" 원");
            userNo = result.item.userNo
            itemNo = result.item.itemNo;
            elat = result.maps.latitude;
            elng = result.maps.longitude;
            //지도표시
            var loc = new daum.maps.LatLng(result.maps.latitude, result.maps.longitude);
            var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
            mapOption = {
                center: loc, // 지도의 중심좌표
                level: 3, // 지도의 확대 레벨
                mapTypeId : daum.maps.MapTypeId.ROADMAP // 지도종류
            }; 
            var map = new daum.maps.Map(mapContainer, mapOption); 
            var mapTypeControl = new daum.maps.MapTypeControl();
            map.addControl(mapTypeControl, daum.maps.ControlPosition.TOPRIGHT); 
            var zoomControl = new daum.maps.ZoomControl();
            map.addControl(zoomControl, daum.maps.ControlPosition.RIGHT);
            marker = new daum.maps.Marker({
                map: map,
                position: loc
            });
            
            $('#itemphoto').html(template2Engine(thumb));
            $('#itemphoto').append(template4Engine(photo));
            $('#actname').html('<div style="text-align: center;">' + result.user.userId + '</div>');
            $('#title').html('<h3 class="mb-0"><div>' + result.item.title + '</div></h3>');
            //$('#title').append('<div style="padding-top: 20px !important;">' + result.item.name + '</div>');
            $('#title').append('<div style="padding-top: 10px !important;">' + result.item.content + '</div>');
            $('#date').html(template3Engine(result.item));
            if (result.item.status != 0) {
                $('#priceBtn').prop("disabled",'true').html("거래중입니다");
                $('#dealBtn').hide();
            }
        }
    });
    
    $.ajax('/json/rv/' + arr[1], {
        dataType: 'json',
        success: (result) => {
            if (result.review == null) {
                return false;
            }
            $('#rivewBar').show();
            $('#review').html("<div class='d-inline-flex align-items-stretch'>"
            +"<div id='userpic' class='d-inline-block rounded-circle' style='width:50px; height: 50px;background-size: 100% 100%'></div></div>"
            +"<div class='d-inline-flex align-items-stretch flex-column-reverse align-top ml-3'>"
            +"<div id='starpic' class='d-inline-block' style='width:100px; height: 19px;background-size: 100% 100%;'></div>"
            +"<div class='d-inline-block mb-2' style='text-align: left;width:100px; height: 19px;background-size: 100% 100%;'>"+result.review.actname+"</div></div>"
            +"<div class='mt-2'>"+result.review.contents+"</div>")
            var starpic;
            switch (result.review.star) {
            case 0: 
                starpic="star0.png"; 
                break;
            case 1: 
                starpic="star1.png"; 
                break;
            case 2: 
                starpic="star2.png"; 
                break;
            case 3: 
                starpic="star3.png"; 
                break;
            case 4: 
                starpic="star4.png";
                break;
            case 5: 
                starpic="star5.png";
            }
            $("#userpic").css("background-image","url('/download/"+result.review.userPic+"')");
            $("#starpic").css("background-image","url('/images/"+starpic+"')");
        },
        error: (request,status,error) => {
            swal("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
    });

//계산버튼클릭시 수행
function distanceCalculator() {
    var distance = getDistanceFromLatLonInKm(slat,slng,elat,elng);
    $('#distance').html(distance);
}
//거리 계산 함수
function getDistanceFromLatLonInKm(lat1,lng1,lat2,lng2) {
    function deg2rad(deg) {
        return deg * (Math.PI/180)
    }
    var R = 6371; // Radius of the earth in km
    var dLat = deg2rad(lat2-lat1);  // deg2rad below
    var dLon = deg2rad(lng2-lng1);
    var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2);
    var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    var d = R * c; // Distance in km
    return d.toFixed(3)+"Km";
}    

/*배송비 결제에 따른 가격변동 */
$('.deliberypay').change(() => {
    if ($('#prepaid').prop("checked")) {
        price += 2500;
        $('#pr').html(transPrice(price)+" 원");
    }
    if ($('#afterpay').prop("checked")) {
        price -= 2500;
        $('#pr').html(transPrice(price)+" 원");
    }
})

//결제시 호출되는 함수
function pay() {
    $('#closeModal').trigger('click');
    var deliveryPayType;
    if ($('#prepaid').prop("checked")) {
        deliveryPayType = 1;
    } else {
        deliveryPayType = 0;
    }
    var payMethod = $('.payMethod:checked').val();
    
    $.ajax('/json/item/' + itemNo, {
        }
    ).done(function(data){
        var price;
        if (deliveryPayType == 1) {
            price = data.item.price + 2500;
        } else {
            price = data.item.price;
        }
        
        $.ajax('/json/auth/loginUser', {
            success: (result) => {
                if (result.user.baseAddress == "") {
                    swal("회원정보를 추가해주세요!!").then((value) => {
                    location.href = '../user/view.html';
                    })
                    throw stop;
                }
            }
        }).done(function(lender) {
            if (data.item.userNo == lender.user.userNo){
                swal('본인 아이템을 구매할 수 없습니다');
                throw stop;
        }
        IMP.request_pay({ // param
            pay_method: payMethod, // card:카드결제 trans:계좌이체 phone:휴대폰 결제
            merchant_uid: lender.user.id+"/"+data.item.itemName+"?"+data.item.itemNo, //아이템 번호 넣으면 될듯..결제가 된 적이 있는 merchant_uid로는 재결제 불가
            name: data.item.name, //물품명
            amount: price, //결제 가격
            //notice_url: "",
            buyer_email: lender.user.email, //tel빼고 나머지 아래 모두 선택요소 
            buyer_name: lender.user.userName,
            buyer_tel: lender.user.phone, //필수
            buyer_addr: lender.user.baseAddress +' '+ lender.user.detailAddress,
            buyer_postcode: lender.user.postNo
        }, function (rsp) { // callback 
            if (rsp.success) { // 결제 성공 시: 결제 승인 또는 가상계좌 발급에 성공한 경우
                // jQuery로 transaction add
                var item_no = (rsp.merchant_uid).split("?")[1];
                console.log(item_no);
                $.ajax("/json/tr/add", {
                    method: "POST",
                    dataType: 'json',
                    data: {
                        //imp_uid: rsp.imp_uid, //아임포트 거래 고유 번호
                        itemNo: item_no ,
                        payMethod: rsp.pay_method,
                        payDate: moment(rsp.paid_at*1000).format('YYYY-MM-DD'),
                        deliveryPayType: deliveryPayType
                    },
                    success: (result) => {
                        swal('결제성공');
                        $('#priceBtn').prop("disabled",'true').html("결제완료");
                        $('#dealBtn').hide();
                    },
                    error: (request,status,error) => {
                        swal("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                        }
                    
                });
                
            } else {
                swal("결제에 실패하였습니다. 에러 내용: " +  rsp.error_msg);
            }
        });
        });
    
    
    });
};

function transPrice(price) {
    var len, point, str, price;

    price = price + "";
    point = price.length % 3 ;
    len = price.length;

    str = price.substring(0, point);
    while (point < len) {
       if (str != "") str += ",";
       str += price.substring(point, point + 3);
       point += 3;
    }

    return str;
}

$(function(){
    $('html').removeClass("no-js");
})
</script>

</body>
</html>
