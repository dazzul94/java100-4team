
<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<style>
.scale {
  transform: scale(1);
  -webkit-transform: scale(1);
  -moz-transform: scale(1);
  -ms-transform: scale(1);
  -o-transform: scale(1);
  transition: all 0.3s ease-in-out;   /* 부드러운 모션을 위해 추가*/
}
.scale:hover {
  transform: scale(3.2);
  -webkit-transform: scale(3.2);
  -moz-transform: scale(3.2);
  -ms-transform: scale(3.2);
  -o-transform: scale(3.2);
}
.img {width:325px; height:280px; overflow:hidden } /* 부모 태그에 사이즈를 지정하여 확대시 벗어나지 않도록 한다. */
</style>
<title>아이템 상세 정보</title>
</head>

<body>

<header></header>

<div class="container">
<div class="row">
<div class="col-md-4 col-sm-6 col-xs-12 mx-auto">
<div class="card-body">
    <div id='aa' class="card-text">
  </div>
    
      <h4 id='actname' class="py-3 text_center" style="color:#3680C1"></h4>
      <p class="text_center text-muted"></p>
  
</div>
<div class="card-body text-center">
<p id="title" class="card-text"></p>
</div>
</div>
</div>

<div class="row">
<div class="col-sm-6 mx-auto">
<div class="card-body" style="display: block;">
<p id="date" class="card-text text_right text-muted"></p>
</div>
</div>
</div>
<div class="row">
<div class="mx-auto">
<button id='priceBtn' type="button" class="btn btn-primary float-right" 
        data-toggle="modal" data-target="#priceModal">결제하기</button>
<button id='addItemBtn' type="button" class="btn btn-primary float-right" 
    onclick='location.href="/html/item/form.html"'>등록하기</button>
    </div>
</div>

<hr style="border-color: #bababa;" class="mt-5 col-6"> 
    
<div class="row py-2">
<div class="mx-auto">
    <div id="itemphoto"></div>
    </div>
</div>
<div id='review' style="width:400px;margin:auto;">
</div>
</div>
<br><br><br><br><br><br><br><br><br>

<!--결제창 -->
<div class="modal fade" id="priceModal" tabindex="-1" role="dialog" aria-labelledby="priceModalLabel" aria-hidden="true" style="display: none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="priceModalLabel">결제화면</h5>
        <button id='closeModal' type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      <div id='itempic1' class="d-inline-block" style="width:150px; height: 150px;background-size: 100% 100%">
      </div>
      <div id='dp' class="d-inline-block mt-3 ml-3" style="position: absolute;">
      <span id='pr'></span>
      <div class='py-4' id='itemName'></div>
      </div>
      <div class='m-3'>
      결제 방법: 
       <input class="payMethod" type="radio" name="payMethod" value="card">
       카드결제
       <input class="payMethod" type="radio" name="payMethod" value="trans">
       실시간 계좌 이체
       <input class="payMethod" type="radio" name="payMethod" value="phone">
       휴대폰 결제
      </div>
      <div class='m-3'>
      배송비 유형:
      <input id='prepaid' class='deliberypay' type="radio" name="deliveryPayType" value=1 checked>선불
      <input id='afterpay' class='deliberypay' type="radio" name="deliveryPayType" value=0>착불
      </div>
      <div class="modal-footer">
      </div>
        <button type="button" class="btn btn-primary" onclick="pay()">결제</button>
      </div>
    </div>
  </div>
</div>


<script id='t1' type="text/x-handlebars-template">
{{#each photos}}
<a href="/download/{{thumbnailName}}">
    <img src="/download/{{thumbnailName}}" class="img-responsive rounded-circle" style="width:100%"></a>
{{/each}}
</script>
<script id='t2' type="text/x-handlebars-template">
{{#each this}}
<a data-toggle="modal" data-target="#exampleModal{{@index}}" href="/download/{{this}}">
    <img src="/download/{{this}}" style="height: 225px; width: 250px; display: inline-block; margin: 10px;"></a>
{{/each}}
</script>
<script id='t4' type="text/x-handlebars-template">
{{#each this}}
<div class="modal fade" id="exampleModal{{@index}}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      <div class="modal-body mx-auto">
        <img class="img-fluid" src="/download/{{this}}"></a>
        <div id="kartik-file-errors"></div>
      </div>
      <div class="modal-footer">
      </div>
    </div>
  </div>
</div>
{{/each}}
</script>

<script id='t3' type="text/handlebars-template">
<table class="table table-bordered">
<tbody><tr><th style="background-color: #f3f3f3;" class="text-center align-middle" rowspan="4">대여</th></tr>
<tr><td><span>물품</span><span style="float: right;">{{name}}</span></td></tr>
<tr><td class="text-muted" type="date"><span>기간</span><span style="float: right;">{{formatDate startDate}} ~ {{formatDate endDate}}</span></td></tr>
<tr><td><span>가격</span><span style="float: right;">{{fb price}}<i class="fa fa-krw"></i></span></td></tr>
</tbody>
</table>
</div>
</script>

<script src='/node_modules/handlebars/dist/handlebars.min.js'></script>
<script src='/node_modules/moment/moment.js'></script>

<script src='/node_modules/jquery/dist/jquery.min.js'></script>
<script src='/node_modules/popper.js/dist/umd/popper.min.js'></script>
<script src='/node_modules/bootstrap/dist/js/bootstrap.min.js'></script>
<script type="text/javascript" src="https://service.iamport.kr/js/iamport.payment-1.1.5.js"></script>



<script type="text/javascript">

var IMP = window.IMP;
IMP.init("imp92089366");
var itemNo, price;
var template1Src = $('#t1').html(),
template2Src = $('#t2').html(),
template3Src = $('#t3').html(),
template4Src = $('#t4').html(),
template1Engine = Handlebars.compile(template1Src),
template2Engine = Handlebars.compile(template2Src),
template3Engine = Handlebars.compile(template3Src),
template4Engine = Handlebars.compile(template4Src);

$('header').load('../header.html');

Handlebars.registerHelper('fb', function(price) {
    var len, point, str, price;

    price = price + "";
    point = price.length % 3 ;
    len = price.length;

    str = price.substring(0, point);
    while (point < len) {
       if (str != "") str += ",";
       str += price.substring(point, point + 3);
       point += 3;
    }

    return str;
});

Handlebars.registerHelper('formatDate', function(date) {
    return moment(date).format('YYYY-MM-DD');
});

var index = location.href.indexOf('?');

if (index != -1) { // 기존 데이터를 조회할 경우
    var qs = location.href.substr(index + 1);
    var arr = qs.split('=');
}   
$('#addItemBtn').hide();
    $.ajax('/json/item/' + arr[1], {
        dataType: 'json',
        success: (result) => {
            $('#aa').html(template1Engine(result.user));
            for (var data of result.item.photos) {
                var photo = data.photoName.split(',');
                var thumb = data.thumbnailName.split(',');
            }
            if (result.item.userType == 1) {
                $('#addItemBtn').show();
                $('#priceBtn').hide();
            }
            $('#itempic1').css("background-image","url('/download/"+thumb[0]+"')");
            $('#itemName').html('물품명:'+result.item.name);
            price = result.item.price + 2500;
            $('#dp').prepend('기간 : ' + moment(result.item.startDate).format('YYYY-MM-DD') + ' ~ ' +
                    moment(result.item.endDate).format('YYYY-MM-DD') +'<br><br>' + 
                    '가격 : ');
            $('#pr').html(price);
            itemNo = result.item.itemNo;
            $('#itemphoto').html(template2Engine(thumb));
            $('#itemphoto').append(template4Engine(photo));
            $('#actname').html('<div style="text-align: center;">' + result.account.accountName + '</div>');
            $('#title').html('<h3 class="mb-0"><div>' + result.item.title + '</div></h3>');
            //$('#title').append('<div style="padding-top: 20px !important;">' + result.item.name + '</div>');
            $('#title').append('<div style="padding-top: 10px !important;">' + result.item.content + '</div>');
            $('#date').html(template3Engine(result.item));
            if (result.item.status == 1)
            $('#priceBtn').prop("disabled",'true').html("결제완료");
            
        }
    });
    
    $.ajax('/json/rv/' + arr[1], {
        dataType: 'json',
        success: (result) => {
            if (result.review == null) {
                return false;
            }
            $('#review').html("구매자사진:<div id='userpic' class='d-inline-block' style='width:50px; height: 50px;background-size: 100% 100%'></div>"
            +"별점:<div id='starpic' class='d-inline-block' style='width:100px; height: 19px;background-size: 100% 100%'></div>"
            +"코멘트:"+result.review.contents)
            var starpic;
            switch (result.review.star) {
            case 1: 
                starpic="star1.png"; 
                break;
            case 2: 
                starpic="star2.png"; 
                break;
            case 3: 
                starpic="star3.png"; 
                break;
            case 4: 
                starpic="star4.png";
                break;
            case 5: 
                starpic="star5.png";
            }
            $("#userpic").css("background-image","url('/download/"+result.review.userPic+"')");
            $("#starpic").css("background-image","url('/images/"+starpic+"')");
        },
        error: (request,status,error) => {
            alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
            }
    });
    
/*배송비 결제에 따른 가격변동 */
$('.deliberypay').change(() => {
    if ($('#prepaid').prop("checked")) {
        price += 2500;
        $('#pr').html(price);
    }
    if ($('#afterpay').prop("checked")) {
        price -= 2500;
        $('#pr').html(price);
    }
})

//결제시 호출되는 함수
function pay() {
    $('#closeModal').trigger('click');
    var deliveryPayType;
    if ($('#prepaid').prop("checked")) {
        deliveryPayType = 1;
    } else {
        deliveryPayType = 0;
    }
    var payMethod = $('.payMethod:checked').val();
    
    $.ajax('/json/item/' + itemNo, {
        }
    ).done(function(data){
        var price;
        if (deliveryPayType == 1) {
            price = data.item.price + 2500;
        } else {
            price = data.item.price;
        }
        
        $.ajax('/json/auth/loginUser', {
            success: (result) => {
                if (result.user.baseAddress == "") {
                    alert("회원정보를 추가해주세요!!");
                    location.href = '../user/view.html';
                    return false;
                }
            }
        }).done(function(lender) {
            if (data.item.userNo == lender.user.userNo){
                alert('본인 아이템을 구매할 수 없습니다');
                return false;
        }
        IMP.request_pay({ // param
            pay_method: payMethod, // card:카드결제 trans:계좌이체 phone:휴대폰 결제
            merchant_uid: data.item.itemNo, //아이템 번호 넣으면 될듯..결제가 된 적이 있는 merchant_uid로는 재결제 불가
            name: data.item.name, //물품명
            amount: price, //결제 가격
            //notice_url: "",
            buyer_email: lender.account.email, //tel빼고 나머지 아래 모두 선택요소 
            buyer_name: lender.account.name,
            buyer_tel: lender.user.phone, //필수
            buyer_addr: lender.user.baseAddress +' '+ lender.user.detailAddress,
            buyer_postcode: lender.user.postNo
        }, function (rsp) { // callback 
            if (rsp.success) { // 결제 성공 시: 결제 승인 또는 가상계좌 발급에 성공한 경우
                // jQuery로 transaction add
                $.ajax("/json/tr/add", {
                    method: "POST",
                    dataType: 'json',
                    data: {
                        //imp_uid: rsp.imp_uid, //아임포트 거래 고유 번호
                        itemNo: rsp.merchant_uid ,
                        payMethod: rsp.pay_method,
                        payDate: moment(rsp.paid_at*1000).format('YYYY-MM-DD'),
                        deliveryPayType: deliveryPayType
                    },
                    success: (result) => {
                        alert('결제성공');
                        $('#priceBtn').prop("disabled",'true').html("결제완료");
                    },
                    error: (request,status,error) => {
                        alert("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                        }
                    
                });
                
            } else {
                alert("결제에 실패하였습니다. 에러 내용: " +  rsp.error_msg);
            }
        });
        });
    
    
    });
};

</script>



</body>
</html>
