
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>메세지관리</title>

<link rel="stylesheet" href='/node_modules/bootstrap/dist/css/bootstrap.min.css'>
<link href="http://fonts.googleapis.com/earlyaccess/nanumgothic.css" rel="stylesheet" type="text/css">

</head>
<body>
<header></header>
<div class='container'>
<div class="row col-3 mt-3" style="float: left;">
    <div class="mb-1 alert col-10 alert-primary" onclick="location.href='../tr/list.html'" style="cursor: pointer;" role="alert">
      <a style='text-decoration:none;' href='../tr/list.html'>이용내역</a>
    </div>
    
    <div class="mb-1 alert col-10 alert-primary" onclick="location.href='../user/view.html'" style="cursor: pointer;" role="alert">
      <a style='text-decoration:none;' href='../user/view.html'>회원정보변경</a>
    </div>
    
    <div class="alert col-10 alert-primary" onclick="location.href='../msg/list.html'" style="cursor: pointer;" role="alert">
      <a style='text-decoration:none;' href='../msg/list.html'>메시지</a>
    </div>
<input id="btn2" type="file" class="form-control-file col-1" id="photo" name="photo" style='opacity: 0;'>
</div>
<div style='display:inline-block;position: absolute;width:690px; margin-left:50px; padding-top:25px;'>
<a class="btn btn-success" href='form.html'>추가(삭제예정)</a>

<table id='list' style='margin-top: 10px;'class='table'>
<thead class="thead-dark">
<tr>
<th>번호</th><th>수신확인</th><th>제목</th><th>날짜</th>
</tr>
</thead>
<tbody>

<!-- <input style='align-content: flex-start;' -->
</tbody>
</table>
</div>
</div>


<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">메세지</h5>
        <button type="button" class="close" data-dismiss="modal" onclick='load()' aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    <div id="modalView" class="modal-body">
      
    </div>
      <div class="modal-footer">
        
      </div>
    </div>
  </div>
</div>

<script id="t1" type="text/x-handlebars-template">
<div style="width:450px;margin:auto;">    
    <div style="display:inline-block;margin-bottom:20px;">
      제목 : {{title}}
    </div>
    <div style="display:inline-block;float:right;margin-right:25px;">
      보낸 날짜 : {{formatDate dispatchDate}}
    </div>
    <div>
        <span>내용</span>
      <div style="width:380px;height:200px;border:solid 1px #b5b5b5;display:inline-block;padding:2px 10px;margin-left:10px;">{{content}}
      </div>
    </div>
</div>
</script>

<script id="t2" type="text/x-handlebars-template">
<button id='delBtn' data-no='{{messageNo}}' type="button" class="btn btn-primary">메세지 삭제</button>
</script>

<script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>
<script src="https://static.nid.naver.com/js/naveridlogin_js_sdk_2.0.0.js" charset="utf-8"></script>
<script src='/node_modules/handlebars/dist/handlebars.min.js'></script>
<script src='/node_modules/moment/moment.js'></script>
<script src='/node_modules/jquery/dist/jquery.min.js'></script>
<script src='/node_modules/popper.js/dist/umd/popper.min.js'></script>
<script src='/node_modules/bootstrap/dist/js/bootstrap.min.js'></script>
<script src='/node_modules/sweetalert/dist/sweetalert.min.js'></script>

<script type="text/javascript">
$('header').load('../header.html');
template1Src = $('#t1').html(),
template1Engine = Handlebars.compile(template1Src);
template2Src = $('#t2').html(),
template2Engine = Handlebars.compile(template2Src);
Handlebars.registerHelper('formatDate', function(date) {
    return  moment(date).format('YYYY-MM-DD');
});

var tbody = $('#list > tbody')
load();

function load() {
   
    $.ajax('/json/msg/list', {
        dataType: 'json',
        success: (result) => {
            
            tbody.html(""); 
            
            for (var data of result.message) {
                var photo;
                if (data.state == false) {
                    photo = 'noread.png';
                } else {
                    photo = 'read.png';
                }
                $('<tr>')
                    .html(  
                        "<td>" + data.messageNo + "</td>" + 
                        "<td><img src=/images/" + photo + "></td>" +
                        "<td><a id='m"+ data.messageNo +"' data-toggle='modal' data-target='#exampleModalCenter' style='cursor: pointer;' class='detailView'>" + data.title + "</a></td>" + 
                        "<td>" + moment(data.dispatchDate).format('YYYY-MM-DD') + "</td>")
                    .appendTo(tbody);
            }
            viewEvent();
        
        },
        error: () => {
            swal('서버 실행 오류!');
        }
    });
}
//이벤트 등록
function viewEvent() {
//뷰실행
$('.detailView').on('click',(e) => {
    var num = $(e.target).attr('id').split("m")[1];
        $.ajax('/json/msg/' + num, {
            dataType: 'json',
            success: (result) => {
                $('.modal-body').html(template1Engine(result.message));
                $('.modal-footer').html(template2Engine(result.message));
                delEvent();
            },
            error: () => {
                swal('서버 실행 오류!');
            }
        });
});

};
function delEvent() {
$('#delBtn').on('click',(e) => {
    var num = $(e.target).attr('data-no');
  $.ajax('/json/msg/delete', {
        data: {
            no: num
        },
        dataType: 'json',
        success: (result) => {
            location.href = "list.html";
        },
        error: () => {
            swal('서버 실행 오류!');
        }
    });
});
};




</script>


</body>
</html>
    
    
    
    
    
    
    
    
    
    