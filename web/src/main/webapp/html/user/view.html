<!DOCTYPE html>
<html class="no-js">
<head>
<meta charset="UTF-8">
<title>회원관리</title>

<link rel="stylesheet"
    href='../../node_modules/bootstrap/dist/css/bootstrap.min.css'>
<script src="https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js"></script>
<link href="../../css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="../../css/main.css">
<!-- <link href="../../css/freelancer.min.css" rel="stylesheet">
<link href="../../css/bootstrap.min.css" rel="stylesheet">
<link href="../../css/freelancer.min.css" rel="stylesheet">
<link href="../../css/test.css" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/earlyaccess/nanumgothic.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css"> -->
</head>
<style>
.no-js {
    display: none;
}
img {
    /* max-width: 100%;
    max-height: 100%; */
    width: 135px;
    height: 145px;
    
}

.filebox label { display: inline-block; padding: .5em .75em; color: #999; font-size: inherit; line-height: normal; vertical-align: middle; background-color: #fdfdfd; cursor: pointer; border: 1px solid #ebebeb; border-bottom-color: #e2e2e2; border-radius: .25em; } .filebox input[type="file"] { /* 파일 필드 숨기기 */ position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip:rect(0,0,0,0); border: 0; }
</style>
<body>
    <header> </header>

    <div class='container'>
        <div class="row">
            <div class="col-3 mt-3 d-inline-block">
                <h4 class="">마이쉐어</h4>
                <h5 class="text-muted">
                    <a style='text-decoration: none;' href='../tr/list.html'> <i
                        class="fa fa-home pr-3" style="font-size: 24px"></i>마이쉐어 홈
                    </a>
                </h5>
                <hr>
                <h5 class="text-muted">
                    <i class="fa fa-id-badge pr-3" style="font-size: 24px"></i>개인
                </h5>
                <ul>
                    <li><h6 class="text-muted">
                            <a class="" style='text-decoration: none;'
                                href='../user/view.html'>회원정보변경</a>
                        </h6></li>
                    <li><h6 class="text-muted">
                            <a class="" style='text-decoration: none;'
                                href='../msg/list.html'>메시지</a>
                        </h6></li>
                </ul>
                <hr>
            </div>

            <div class="d-inline-block col-9">
                <form id="form" method='POST' onsubmit="return"
                    enctype="multipart/form-data">
                    <div id="nodiv"></div>


                    <div class="row">
                        <div class="row col-12 mx-auto">
                            <table class="table table-bordered mt-2">
                                <tbody>
                                    <tr>
                               <th class="thwidth text-center" colspan="2">
                            <div id="imdiv" class="mx-auto my-2"></div>
                            <div class="col-3 mx-auto">
                            <div class="mx-auto filebox">
                                <label class="mb-0" for="ex_file">사진변경</label>
                                <input id="ex_file" type="file" class="form-control-file" name="photo">
                                </div></div>
                    <!--        <div class="my-2 mx-auto">
                                <i id="btn1" class="fa fa-camera"
                            style="cursor: pointer; font-size: 36px; color: #007BFF"></i>
                                        </div> -->
                                </th>
                                  </tr>
                                
                                
                                    <tr>
                                        <th style="background-color: #f3f3f3;"
                                            class="thwidth text-center" rowspan="2">아이디</th>
                                    </tr>
                                    <tr>
                                        <td style="background-color: white;" class="pl-3 text-dark">
                                            <!-- <input
                class='borderzero mb-0 form-control col-10' id='userid' type='text'
                name='accountName'> --> <span id="userid"></span>
                                            <button style="float: right;" type="button" id="deleteBtn"
                                                class="btn btn-outline-secondary btn-sm">회원탈퇴</button>
                                        </td>
                                    </tr>

                                    <tr>
                                        <th style="background-color: #f3f3f3;" class="text-center"
                                            rowspan="2">비밀번호</th>
                                    </tr>
                                    <tr>
                                        <td style="background-color: white;" class="text-muted">
                                            <input class='form-control form-control-sm mb-0 col-6'
                                            placeholder="새 비밀번호" id='pwd' type='password' name=password>
                                            <input class='form-control form-control-sm mb-0 col-6'
                                            placeholder="새 비밀번호 확인" id='checkpwd' type='password'>
                                        </td>
                                    </tr>

                                    <tr>
                                        <th style="background-color: #f3f3f3;" class="text-center"
                                            rowspan="2">이메일</th>
                                    </tr>
                                    <tr>
                                        <td style="background-color: white;" class="text-muted"><input
                                            class='form-control form-control-sm mb-0 col-6' id='email'
                                            type='email' name='email'></td>
                                    </tr>


                                    <tr>
                                        <th style="background-color: #f3f3f3;" class="text-center"
                                            rowspan="2">이름</th>
                                    </tr>
                                    <tr>
                                        <td style="background-color: white;" class="pl-3 text-dark">
                                            <!-- <input
                class='mb-0 form-control col-10' readonly id='name' type='text'
                name='name'> --> <span id="name"></span>
                                        </td>
                                    </tr>

                                    <tr>
                                        <th style="background-color: #f3f3f3;" class="text-center"
                                            rowspan="2">은행</th>
                                    </tr>
                                    <tr>
                                        <td style="background-color: white;" class="text-muted"><input
                                            class='form-control form-control-sm mb-0 col-6' id='bank'
                                            type='text' name='bank'></td>
                                    </tr>

                                    <tr>
                                        <th style="background-color: #f3f3f3;" class="text-center"
                                            rowspan="2">통장번호</th>
                                    </tr>
                                    <tr>
                                        <td style="background-color: white;" class="text-muted"><input
                                            class='form-control form-control-sm mb-0 col-6'
                                            id='accountNo' type='text' name='accountNo'></td>
                                    </tr>

                                    <tr>
                                        <th style="background-color: #f3f3f3;" class="text-center"
                                            rowspan="2">한마디</th>
                                    </tr>
                                    <tr>
                                        <td style="background-color: white;" class="text-muted"><input
                                            class='form-control form-control-sm mb-0 col-6' id='comment'
                                            type='text' name='comment'></td>
                                    </tr>

                                    <tr>
                                        <th style="background-color: #f3f3f3;" class="text-center"
                                            rowspan="2">전화번호</th>
                                    </tr>
                                    <tr>
                                        <td style="background-color: white;" class="text-muted"><input
                                            class='form-control form-control-sm mb-0 col-6' id='phone'
                                            type='text' name='phone'></td>
                                    </tr>

                                    <tr>
                                        <th style="background-color: #f3f3f3;" class="text-center"
                                            rowspan="2">우편번호</th>
                                    </tr>
                                    <tr>
                                        <td style="background-color: white;" class="text-muted"><input
                                            class='form-control form-control-sm mb-0 disinline col-6'
                                             id='sample5_postcode' type='text'
                                            name='postNo'> <input
                                            class="disinline btn btn-primary btn-sm col-4" type="button"
                                            onclick="sample5_execDaumPostcode()" value="우편번호 찾기"></td>
                                    </tr>
                                    <tr>
                                        <th style="background-color: #f3f3f3;" class="text-center"
                                            rowspan="2">기본주소</th>
                                    </tr>
                                    <tr>
                                        <td style="background-color: white;" class="text-muted"><input
                                            class='form-control form-control-sm mb-0 col-6'
                                             id='sample5_address' type='text'
                                            name='baseAddress'></td>
                                    </tr>

                                    <tr>
                                        <th style="background-color: #f3f3f3;" class="text-center"
                                            rowspan="2">상세주소</th>
                                    </tr>
                                    <tr>
                                        <td style="background-color: white;" class="text-muted"><input
                                            class='form-control form-control-sm mb-0 col-6'
                                            id='sample5_address2' type='text' name='detailAddress'></td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="mx-auto">
                                <button id="updateBtn" type="button" class="btn btn-primary">변경완료</button>
                            </div>
                        </div>
                    </div>
            <input id='address' type="hidden" name='address' value=""> <input
                id='lat' type="hidden" name='latitude' value=0> <input
                id='lng' type="hidden" name='longitude' value=0>
            
            </form>
            </div>
        </div>
    </div>

    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>

    <script src='/node_modules/jquery/dist/jquery.min.js'></script>
    <script src='/node_modules/popper.js/dist/umd/popper.min.js'></script>
    <script src='/node_modules/bootstrap/dist/js/bootstrap.min.js'></script>
    <script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>
    <script
        src="https://static.nid.naver.com/js/naveridlogin_js_sdk_2.0.0.js"
        charset="utf-8"></script>
    <script src="https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js"></script>
    <script src='/node_modules/sweetalert/dist/sweetalert.min.js'></script>
    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=41a90b1059ade44d7db374c4db586dfb&libraries=services"></script>
    <script>
var password = $('#pwd'),
    pwdcheck = $('#checkpwd'),
    userid = $('#userid'),
    email = $('#email'),
    userName = $('#name'),
    accNo = $('#accountNo'),
    bank = $('#bank'),
    cnt = $('#comment'),
    phone = $('#phone'),
    postNo = $('#sample5_postcode'),
    baseAddr = $('#sample5_address'),
    detailAddr = $('#sample5_address2'),
    photos = $('#photo'),
    addBtn = $('#addBtn'),
    deleteBtn = $('#deleteBtn'),
    imd = $('#imdiv'),
    nod = $('#nodiv'),
    updateBtn = $('#updateBtn');
$('header').load('../header.html');
/* var btn1 = document.querySelector('#btn1')
var btn2 = document.querySelector('#btn2')
btn1.addEventListener('click', function(event) {
  var me = new MouseEvent('click')
  btn2.dispatchEvent(me)
})
btn2.addEventListener('change', function(event) {
    readURL(this);
})
 */
//위도 경도 받기
detailAddr.focus(()=> {
    var geocoder = new daum.maps.services.Geocoder();
    geocoder.addressSearch(baseAddr.val(),function(result, status) {
        console.log(result)
    $('#address').val(result[0].address_name);
    $('#lat').val(result[0].y);
    $('#lng').val(result[0].x);
    })
})
function imageURL(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            $('#replaceMe').attr('src', e.target.result)
             .width(100)
             .height(100);
        }
        reader.readAsDataURL(input.files[0]);
    }
}
var index = location.href.indexOf('?');
if (index != -1) { // 기존 데이터를 조회할 경우
    var qs = location.href.substr(index + 1);
    var arr = qs.split('=');
    $(() => {
        $.ajax('/json/user/' + arr[1], {
            dataType: 'json',
            success: (result) => {
                userid.text(result.user.userId);
                userName.text(result.user.userName);
                email.val(result.user.email);
                bank.val(result.user.bank);
                accNo.val(result.user.accountNo);
                cnt.val(result.user.comment);
                phone.val(result.user.phone);
                postNo.val(result.user.postNo);
                baseAddr.val(result.user.baseAddress);
                detailAddr.val(result.user.detailAddress);
                for (var data of result.user.photos){
                    var filename = data.thumbnailName
                    imd.html( '<img id="imag" align="middle" src="/download/' + filename + '">');
                }
                nod.html("<input id='no' type='hidden' name='userNo' value='" + result.user.userNo + "'>")
            },
            error: () => {
                swal('서버 실행 오류!');
            }
        });
    });
    
} else {
    $(() => {
        $.ajax('/json/user/view' , {
            dataType: 'json',
            success: (result) => {
                email.val(result.user.email);
                userid.text(result.user.userId);
                userName.text(result.user.userName);
                try {
                bank.val(result.user.bank);
                accNo.val(result.user.accountNo);
                cnt.val(result.user.comment);
                phone.val(result.user.phone);
                postNo.val(result.user.postNo);
                baseAddr.val(result.user.baseAddress);
                detailAddr.val(result.user.detailAddress);
                for (var data of result.user.photos){
                    var filename = data.thumbnailName
                    imd.html('<img align="middle" src="/download/' + filename + '">');
                }
                } catch (e) {console.log(e)};
                nod.html("<input id='no' type='hidden' name='userNo' value='" + result.user.userNo + "'>")
            },
            error: () => {
                swal('서버 실행 오류!');
            }
        });
    });
}
    function sample5_execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.
                // 각 주소의 노출 규칙에 따라 주소를 조합한다.
                // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                var fullAddr = ''; // 최종 주소 변수
                var extraAddr = ''; // 조합형 주소 변수
                // 사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                    fullAddr = data.roadAddress;
                } else { // 사용자가 지번 주소를 선택했을 경우(J)
                    fullAddr = data.jibunAddress;
                }
                // 사용자가 선택한 주소가 도로명 타입일때 조합한다.
                if(data.userSelectedType === 'R'){
                    //법정동명이 있을 경우 추가한다.
                    if(data.bname !== ''){
                        extraAddr += data.bname;
                    }
                    // 건물명이 있을 경우 추가한다.
                    if(data.buildingName !== ''){
                        extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // 조합형주소의 유무에 따라 양쪽에 괄호를 추가하여 최종 주소를 만든다.
                    fullAddr += (extraAddr !== '' ? ' ('+ extraAddr +')' : '');
                }
                // 우편번호와 주소 정보를 해당 필드에 넣는다.
                document.getElementById('sample5_postcode').value = data.zonecode; //5자리 새우편번호 사용
                document.getElementById('sample5_address').value = fullAddr;
                // 커서를 상세주소 필드로 이동한다.
                document.getElementById('sample5_address2').focus();
            }
        }).open();
    }
    
    function readURL(input) {
        if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function (e) {
                $('#imag').attr('src', e.target.result);
        }
          reader.readAsDataURL(input.files[0]);
        } 
    }
    
updateBtn.click(() => {
    if (password.val() != pwdcheck.val()) {
        swal('비밀번호가 틀렸습니다. 다시 입력해 주세요');
        return false;
    }
    
    var formData = new FormData($("#form")[0]);
    $.ajax('/json/user/update', {
        data : formData,
        dataType: 'json',
        method: 'POST',
        processData : false,
        contentType : false,
        success: (result) => {
            $('#imag').change(() => {
            imd.html("");
            for (var data of result.status) {
                var filename = data.photoName;
                console.log(filename)
                return imd.html( '<img id="imag" src="/download/' + filename + '">');
                }
            });
            swal('수정되었습니다.').then((value) => {
            location.reload();
            });
        },
        error:function(request,status,error){
            swal("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
         }
    });
});
deleteBtn.click(() => {
    swal("password를 입력하세요", {content: {element: "input",attributes: { type:"password"}}}).then((pwd) => {
        
    $.ajax('/json/user/checkPwd', {
        
        data : {
            password: pwd
        },
        success: (count) => {
            console.log("no:"+$('#no').val())
            if (count == 1) {
                $.ajax('/json/user/delete', {
                    data : {
                        no: $('#no').val()
                    },
                    dataType: 'json',
                    success: (result) => {
                        swal("회원탈퇴가 완료되었습니다.!").then((value) => {
                        $.getJSON('/json/auth/logout', (result) => {
                            location.href = '../item/list.html';
                        });
                            })
                    },
                    error: () => {
                        swal('서버 실행 오류!');
                    }
                });
            } else {
                swal('password입력이 틀렸습니다!!')
            }
        },
        error: () => {
            swal('서버 실행 오류!');
        }
    })
    })
    
});
$(function(){
    $('html').removeClass("no-js");
})
</script>
</body>
</html>