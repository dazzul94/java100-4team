
<!DOCTYPE html>
<html class="no-js">
<head>
<meta charset="UTF-8">
<title>이용내역</title>
<link href="../../css/bootstrap.min.css" rel="stylesheet">
<script src="https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js"></script>
<link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="../../css/main.css">

<style type="text/css">
.no-js {display:none;}

body {
-webkit-transform: 'rotate(30deg)'
}
</style>
<!-- 별점 스타일-->
<style>
.star-input>.input,
.star-input>.input>label:hover,
.star-input>.input>input:focus+label,
.star-input>.input>input:checked+label{display: inline-block;vertical-align:middle;background:url('/images/star.png') no-repeat;}
.star-input{display:inline-block; white-space:nowrap;width:225px;height:40px;line-height:30px;}
.star-input>.input{display:inline-block;width:100px;background-size:100px;height:19px;white-space:nowrap;overflow:hidden;position: relative;}
.star-input>.input>input{position:absolute;width:1px;height:1px;opacity:0;}
star-input>.input.focus{outline:1px dotted #ddd;}
.star-input>.input>label{width:30px;height:0;padding:19px 0 0 0;overflow: hidden;float:left;cursor: pointer;position: absolute;top: 0;left: 0;}
.star-input>.input>label:hover,
.star-input>.input>input:focus+label,
.star-input>.input>input:checked+label{background-size: 100px;background-position: 0 bottom;}
.star-input>.input>label:hover~label{background-image: none;}
.star-input>.input>label[for="p1"]{width:20px;z-index:5;}
.star-input>.input>label[for="p2"]{width:40px;z-index:4;}
.star-input>.input>label[for="p3"]{width:60px;z-index:3;}
.star-input>.input>label[for="p4"]{width:80px;z-index:2;}
.star-input>.input>label[for="p5"]{width:100px;z-index:1;}
.star-input>output{display:inline-block; font-size:18px;text-align:right; vertical-align:middle;}
</style>

</head>
<body>
<header></header>
<div class='container'>
<div class="row">
<div class="col-3 mt-3 d-inline-block" >
    <h4 class="">마이쉐어</h4>
        <h5 class="text-muted"><a style='text-decoration:none;' href='../tr/list.html'>
        <i class="fa fa-home pr-3" style="font-size:24px"></i>마이쉐어 홈</a></h5>
        <ul>
         <li><div id="buyBtn"><h6 class="text-muted">
          <a class="" href='#'>구매내역</a></h6></div></li>
         <li><div id="sellBtn"><h6 class="text-muted">
          <a class="" href='#'>판매내역</a></h6></div></li>
        </ul>
    <hr>
    <h5 class="text-muted"><i class="fa fa-id-badge pr-3" style="font-size:24px"></i>개인</h5>
    <ul>
      <li><h6 class="text-muted">
      <a class="" style='text-decoration:none;' href='../user/view.html'>회원정보변경</a></h6></li>
      <li><h6 class="text-muted">
      <a class="" style='text-decoration:none;' href='../msg/list.html'>메시지</a></h6></li>
    </ul>
    <hr>
</div>
    
<div class="d-inline-block col-9">
<div class="row col-12 mx-auto">
<!-- <div>
<button id='buyBtn' type="button" class="btn btn-dark">구매내역</button>
<button id='sellBtn' type="button" class="btn btn-outline-dark">판매내역</button>
</div> -->

<table id='list' style='margin-top: 10px;'class='table text-center'>
<thead class="thead-light">
<tr>
<th>신청일</th><th>상품명</th><th>금액</th><th>대여기간</th><th>현황</th><th id="thAdd"></th>
</tr>
</thead>
<tbody>


</tbody>
</table>
</div>
</div>

</div>
</div>
<!-- 리뷰 -->
<div class="modal fade" id="reviewModal" tabindex="-1" role="dialog" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content" style="width:370px;">
      <div class="modal-header">
      <div class="mx-auto">
        <h4 class="modal-title" id="exampleModalLongTitle">
        <a onclick="location.href='/html/item/list.html'"
                style="color: #0160c5;" class="" href="#">리뷰<i class="fa fa-handshake-o" style="font-size: 24px; color: #0160c5"></i>등록</a></h4>
                </div>
      </div>
      <div class="modal-body">
      <div class="textcenter">
      <div id='itemPic' class="d-inline-block" style="width:150px; height: 150px;background-size: 100% 100%">
      </div>
      
      <div class="d-inline-block pl-2" style="vertical-align: top;">
      <div id='itemName'></div>
      <div id='price'></div>
      </div>
      
      <div class='m-3' style="clear:both;">
      별점주기
       <span class="star-input">
    <span class="input">
        <input type="radio" name="star-input" value="1" id="p1">
        <label for="p1">1</label>
        <input type="radio" name="star-input" value="2" id="p2">
        <label for="p2">2</label>
        <input type="radio" name="star-input" value="3" id="p3">
        <label for="p3">3</label>
        <input type="radio" name="star-input" value="4" id="p4">
        <label for="p4">4</label>
        <input type="radio" name="star-input" value="5" id="p5">
        <label for="p5">5</label>
    </span>
    <output id="output"for="star-input"><b>3</b></output>
</span>
    <input id='rentNo' type="hidden">
    <input id='itemNo' type="hidden">
      </div>
      <div class='m-3 mx-auto'>
      리뷰 <br>
      <textarea id='comment'></textarea>
      </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary m-auto" onclick="reviewAdd()">등록</button>
      </div>
    </div>
  </div>
</div>
</div>

<!-- 배송등록 -->
<div class="modal fade" id="deliveryModal" tabindex="-1" role="dialog" aria-labelledby="deliveryModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
      <div class="mx-auto">
        <h4 class="modal-title" id="exampleModalLongTitle">
        <a onclick="location.href='/html/item/list.html'"
                style="color: #0160c5;" class="" href="#">배송<i class="fa fa-handshake-o" style="font-size: 24px; color: #0160c5"></i>등록</a></h4>
                </div>
      </div>
      <div class="modal-body">
      <div>
      배송지 정보
        <div>
            <span id='lenderName'></span><span style="margin-left:30px;" id='lenderPhone'></span><div id='lenderAddr'></div>
        </div>
      </div>
      <div>
      택배회사:<input id="parcel" type="text" name="parcel">
      </div>
      <div>
      운송장번호:<input class="form-control" id="deliveryNo" type="number" name="deliveryNo">
      </div>
      <input id='rentNo2' type="hidden">
      <input id='itemNo2' type="hidden">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary m-auto" onclick="deliveryAdd()">등록</button>
      </div>
    </div>
  </div>
</div>

<script src='/node_modules/handlebars/dist/handlebars.min.js'></script>
<script src='/node_modules/moment/moment.js'></script>
<script src='/node_modules/jquery/dist/jquery.min.js'></script>
<script src='/node_modules/popper.js/dist/umd/popper.min.js'></script>
<script src='/node_modules/bootstrap/dist/js/bootstrap.min.js'></script>
<script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>
<script src="https://static.nid.naver.com/js/naveridlogin_js_sdk_2.0.0.js" charset="utf-8"></script>
<script src='/node_modules/sweetalert/dist/sweetalert.min.js'></script>

<script type="text/javascript">
$('header').load('../header.html');

var tbody = $('#list > tbody')


load();

//구매내역클릭
$('#buyBtn').click(()=> {
    /* $('#buyBtn').removeClass('btn-outline-dark').addClass('btn-dark');
    $('#sellBtn').removeClass('btn-dark').addClass('btn-outline-dark'); */
    load();
});

//판매내역클릭
$('#sellBtn').click(()=> {
   /*  $('#buyBtn').removeClass('btn-dark').addClass('btn-outline-dark');
    $('#sellBtn').removeClass('btn-outline-dark').addClass('btn-dark'); */
    load2();
});

//별점 기본값 3으로..
$('#p3').prop("checked",true);

//기본 화면 로딩
function load() {
    $.ajax('/json/tr/list', {
        dataType: 'json',
        success: (result) => {
            tbody.html("");
            $('#thAdd').html("리뷰등록")
            if (result.transaction == "") {
                $('<tr>').html("<td colspan='6'>거래 내용이 없습니다</td>").appendTo(tbody);
            } else {
            for (var data of result.transaction) {
                var status;
                switch (data.item.status) {
                case 1: status="거래중";
                break;
                case 2: status="거래완료";
                break;
                case 3: status="결제완료";
                break;
                case 4: status="<a class='deliveryInfo' data-rentNo='"+data.no+
                "' data-itemNo='"+data.item.itemNo+"' href=#>배송중</a>";
                break;
                case 5: status="수취완료";
                }
            $('<tr>')
            .html(  
                "<td>" + moment(data.payDate).format('YYYY-MM-DD') + "</td>" + 
                "<td><a href='/html/item/view.html?no="+data.itemNo+"'>"+ data.item.itemName + "</a></td>" +
                "<td>"+ data.item.price +"</td>" + 
                "<td>" + moment(data.item.startDate).format('YYYY-MM-DD') + "~"+ 
                moment(data.item.endDate).format('YYYY-MM-DD')+ "</td>" +
                "<td>"+ status +"</td>"+
                "<td>" +"<button id='reviewBtn' style='height:34px;padding:4px' data-rentNo='"+data.no
                +"' data-itemNo='"+data.item.itemNo+"' class='border btn btn-light' "
                +"data-toggle='modal' data-target='#reviewModal'>리뷰등록</button></td>")
            .appendTo(tbody);
            if (data.item.status !=2 && data.item.status !=5) {
                $('.btn-light').last().prop("disabled",'true');
            }
            if (data.reviewState) {
                $('.btn-light').last().prop("disabled",'true').html("등록완료");
            } 
            };
            };
        },
        error: () => {
            swal('서버 실행 오류!');
        }
    });
};

//판매내역 로딩
function load2() {
    $.ajax('/json/tr/list2', {
        type:"POST",
        dataType: 'json',
        success: (result) => {
            
            tbody.html(""); 
            $('#thAdd').html("배송등록");
            if (result.transaction == "") {
                $('<tr>').html("<td colspan='6'>거래 내용이 없습니다</td>").appendTo(tbody);
            } else {
            for (var data of result.transaction) {
                var status;
                switch (data.item.status) {
                case 1: status="<a class='dealAccept' data-rentNo='"+data.no+
                        "' data-itemNo='"+data.item.itemNo+"' href=#>거래중</a>";
                break;
                case 2: status="거래완료";
                break;
                case 3: status="결제완료";
                break;
                case 4: status="배송중";
                break;
                case 5: status="배송완료";
                }
                $('<tr>')
                .html(  
                    "<td>" + moment(data.payDate).format('YYYY-MM-DD') + "</td>" + 
                    "<td><a href='/html/item/view.html?no="+data.itemNo+"'>"+ data.item.itemName + "</a></td>" +
                    "<td>"+ data.item.price +"</td>" + 
                    "<td>" + moment(data.item.startDate).format('YYYY-MM-DD') + "~"+ 
                    moment(data.item.endDate).format('YYYY-MM-DD')+ "</td>" +
                    "<td>"+ status +"</td>"
                    +"<td>" +"<button id='deliveryBtn' style='height:34px;padding:4px;' data-userNo='"
                    +data.lenderNo+"' data-rentNo='"+data.no+"' data-itemNo='"+data.item.itemNo
                    +"' class='border btn btn-light' data-toggle='modal' " 
                    +"data-target='#deliveryModal'>배송등록</button></td>")
                .appendTo(tbody);
                if (data.item.status < 3 || data.item.status == 5) {
                    $('.btn-light').last().prop("disabled",'true');
                }
            };
            };
        },
        error: () => {
            swal('서버 실행 오류!');
        }
    });
};

//리뷰버튼 클릭이벤트
$(tbody).on("click","#reviewBtn",function(e) {
    $('#rentNo').val($(e.target).attr('data-rentNo'));
    $('#itemNo').val($(e.target).attr('data-itemNo'));
    $.ajax('/json/item/'+ $(e.target).attr('data-itemNo'), {
    }
).done(function(result){
    for (var data of result.item.photos) {
        var thumb = data.thumbnailName.split(',');
    $('#itemPic').css("background-image","url('/download/"+thumb[0]+"')");
    $('#itemName').html('<b>'+result.item.itemName+'</b>');
    $('#price').html(result.item.price+' 원');
    }
})
});

//배송중 클릭시 이벤트
$(tbody).on("click","a.deliveryInfo",function(e) {
    var rentNo = $(e.target).attr('data-rentNo');
    var itemNo = $(e.target).attr('data-itemNo');
    
    $.ajax("/json/tr/"+rentNo).done((result)=>{
        var parcel = result.transaction.parcel;
        var deliveryNo = result.transaction.deliveryNo;
     swal({
        html:true,
        title: "배송정보",
        text: "택배회사: "+parcel+"\n\n운송장번호: "
               +deliveryNo+"",
        buttons: {
            confirm: {text: "수취완료", value: true},
            cancel: {text: "닫기",value: false ,visible: true}
        },
    }).then((value)=> {
        if (value) {
            swal({
                text:"확인 버튼을 누르면 수취완료 처리가 됩니다." ,
                buttons: {
                    confirm: {text: "확인", value: true},
                    cancel: {text: "취소",value: false ,visible: true}
                },
            }).then((value)=> {
                if (value) {
                $.ajax("/json/item/update",{
                    type:"POST",
                    dataType: 'json',
                    data:{
                        itemNo: itemNo,
                        status: 5
                        },
                    success: (result) => {
                        swal({
                            text:"수취완료 처리 되었습니다.",
                            icon:"success",
                        })
                        load();
                    }
                })
                }
            })
        }
    }) 
        
    })//done
})

//거래중 클릭시 이벤트
$(tbody).on("click","a.dealAccept",function(e) {
    var rentNo = $(e.target).attr('data-rentNo');
    var itemNo = $(e.target).attr('data-itemNo');
    swal({
        html:true,
        title: "거래를 완료하시겠습니까?",
        text: "거래를 완료하시려면 거래완료버튼을 눌러주세요.\n"
        +"지금 신청자와 거래를 취소하시려면 취소버튼을 눌러주세요",
        buttons: {
            confirm: {text: "거래완료", value: true},
            cancel: {text: "거래취소",value: false ,visible: true}
        },
    }).then((value)=> {
        if (value) {
            $.ajax("/json/item/update",{
                dataType: 'json',
                data:{
                    status: 2,
                    itemNo: itemNo
                },
                success: (result) => {
                    swal("거래가 완료되었습니다.")
                    load2();
                },
                error: () => {
                    console.log('거래완료등록실패');
                }
            })
        } else {
            swal({
                title:"거래 취소",
                text:"정말 거래를 취소하시겠습니까?",
                icon:"warning",
                buttons:{
                        confirm: {text: "OK", value: true},
                        cancel: {text: "NO",value: false ,visible: true}
                        }
            }).then((value)=> {
                if (value) {
                    $.ajax("/json/tr/delete",{
                        dataType: 'json',
                        data:{
                            itemNo: itemNo,
                            rentNo: rentNo
                        },
                        success: (result) => {
                            swal("거래가 취소 되었습니다.")
                            load2();
                        },
                        error: () => {
                            console.log('거래취소실패');
                        }
                    })
                }
            })
        }//else end
    })
    
});

//리뷰등록
function reviewAdd() {
    $('#closeModal').trigger("click");
     $.ajax('/json/rv/add', {
        dataType: 'json',
        data:{
            rentNo: $('#rentNo').val(),
            contents: $('#comment').val(),
            star: $('#output').val(),
            itemNo: $('#itemNo').val(),
            state: 1
        },
        success: (result) => {
          $('#reviewModal').modal('hide');
          swal("리뷰등록성공");
        },
        error: () => {
            swal('리뷰 등록 실패!');
        }
    }); 
}

//배송등록버튼 클릭 이벤트
$(tbody).on("click","#deliveryBtn",function(e) {
    $('#rentNo2').val($(e.target).attr('data-rentNo'));
    $('#itemNo2').val($(e.target).attr('data-itemNo'));
    $('#deliveryNo').val("");
    $('#parcel').val("");
    $.ajax("/json/user/"+$(e.target).attr('data-userNo'),{
        success: (result)=> {
            $('#lenderName').html("구매자 이름: "+result.user.userName);
            $('#lenderPhone').html("구매자 전화번호: "+result.user.phone);
            $('#lenderAddr').html("배송지: "+result.user.baseAddress+" "+result.user.detailAddress);
        }
    })
    $.ajax('/json/tr/'+ $(e.target).attr('data-rentNo'), {}).done(
            function(result) {
                if (result.transaction.deliveryNo != 0) {
                    $('#deliveryNo').val(result.transaction.deliveryNo);
                    $('#parcel').val(result.transaction.parcel);
                }
            });
});

//배송 등록시 실행되는 함수
function deliveryAdd() {
    $('#closeModal2').trigger("click");
    $.ajax('/json/tr/update', {
        dataType: 'json',
        data:{
            no: $('#rentNo2').val(),
            itemNo: $('#itemNo2').val(),
            parcel: $('#parcel').val(),
            deliveryNo: $('#deliveryNo').val(),
        },
        success: (result) => {
          
          $('#deliveryModal').modal('hide');
          swal("배송등록성공");
          load2();
        },
        error: () => {
            swal('배송 등록 실패!');
        }
    
    })
    };


//화면불러오는 애니메이션 
/* jQuery.Tween.propHooks["transform"] = {
get: function(tween) {
  return $(tween.elem).css("transform");
},
set: function(tween) {
  $(tween.elem).css("transform", "rotateY(" + (tween.pos * 360) + "deg)");
}
};
$('body').animate({opacity: 0},0);

$('body').animate({opacity: 1,transform:'rotateY(360deg)'},1000);
*/

//star rating
var starRating = function(){
var $star = $(".star-input"),
$result = $star.find("output>b");
$(document)
.on("focusin", ".star-input>.input", function(){
$(this).addClass("focus");
})
.on("focusout", ".star-input>.input", function(){
var $this = $(this);
setTimeout(function(){
if($this.find(":focus").length === 0){
 $this.removeClass("focus");
}
}, 100);
})
.on("change", ".star-input :radio", function(){
$result.text($(this).next().text());
})
.on("mouseover", ".star-input label", function(){
$result.text($(this).text());
})
.on("mouseleave", ".star-input>.input", function(){
var $checked = $star.find(":checked");
if($checked.length === 0){
$result.text("0");
} else {
$result.text($checked.next().text());
}
});
};
starRating();

$(function(){
    $('html').removeClass("no-js");
})

</script>



</body>
</html>
    
    
    
    
    
    
    
    
    
    