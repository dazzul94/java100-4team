<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="java100.app.dao.ItemDao">
    <resultMap type="item" id="itemMap">
        <id column="it_no" property="itemNo"/>
        <result column="ur_no" property="userNo"/>
        <result column="category" property="category"/>
        <result column="user_type" property="userType"/>
        <result column="item_name" property="name"/>
        <result column="title" property="title"/>
        <result column="cnt" property="content"/>
        <result column="start" property="startDate"/>
        <result column="end" property="endDate"/>
        <result column="price" property="price"/>
        <result column="price_day" property="pricePerDay"/>
        <result column="status" property="status"/>
        <result column="ur_pho" property="filename"/>
        
        <association property="writer" javaType="user">
            <id column="ur_no" property="userNo"/>
        </association>
        
        <association property="account" javaType="Account">
            <id column="act_no" property="accountsNo"/>
            <result column="act_name" property="name"/>
        </association>
        
        <collection property="photos" ofType="Photo">
            <id column="pho_no" property="no"/>
            <result column="it_no" property="itemNo"/>
            <result column="ur_no" property="userNo"/>
            <result column="pho_name" property="photoName"/>
        </collection>
        
    </resultMap>
    
    <select id="countAll" resultType="int">
        select count(*) from item;
    </select>
    
    <insert id="insert" parameterType="item" 
        useGeneratedKeys="true" keyColumn="it_no" keyProperty="itemNo">
        insert into item(ur_no,category,user_type,title,item_name,cnt,start,end,price,price_day,status) 
        values(#{userNo},#{category},#{userType},#{title},#{name},#{content},#{startDate},
                #{endDate},#{price},#{pricePerDay},#{status})
    </insert>
    <select id="findAll" resultMap="itemMap" parameterType="map">
        select 
            i.it_no, i.ur_no, i.category, i.user_type, i.item_name, 
            i.title, i.cnt, i.start, i.end,
            i.price, i.price_day, i.status,
            u.ur_no,
            p.pho_no as pho_no,
            p.it_no as it_no,
            p.ur_no as ur_no,
            p.pho_name as pho_name
            from item as i
            join user as u on i.ur_no=u.ur_no
            left join itemphoto as p on i.it_no=p.it_no
            
            
        <if test="words != null">
            <where>
                <foreach collection="words" item="word">
                    or i.title like '%${word}%'
                </foreach>
            </where>
        </if>
        
        <!-- 정렬 조건에 따라 SQL문을 변경한다.-->
        order by 
        <choose>
            <when test="orderColumn == 'title' and align == 'desc'">
                i.title desc
            </when>
            <when test="orderColumn == 'title' and align == 'asc'">
                i.title asc
            </when>
            <when test="orderColumn == 'it_no' and align == 'desc'">
                i.it_no desc
            </when>
            <when test="orderColumn == 'it_no' and align == 'asc'">
                i.it_no asc
            </when>
            <otherwise>
                i.it_no desc
            </otherwise>
        </choose>
        
        <!-- 페이지징 처리 -->
        limit #{startIndex}, #{size}
    </select>
    
    <select id="findByNo" resultMap="itemMap" parameterType="int">
        select
            a.act_name,
            u.ur_no,
            i.it_no,
            i.title,
            i.item_name,
            i.start,
            i.end,
            i.price,
            p.pho_name,
            (select pho_name from itemphoto where u.ur_no=ur_no)as 
            ur_pho,
            i.price_day
         from item i join user u on u.ur_no=i.ur_no
         left join account a on i.ur_no=a.act_no
         left join itemphoto as p on i.it_no=p.it_no 
            where i.it_no=#{value}
    </select>

</mapper>









